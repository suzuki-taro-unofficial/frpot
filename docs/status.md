# status

沸騰状態、保温状態、停止状態のどの状態なのかを出力するストリームを作る。

## 入力

- `s_temperatureSensor: Stream<number>`
	- 温度センサーから値を受け取るたびに発火する。
	- 現在の実装では`s_tick`と同じタイミング、つまり200ミリ秒ごとに発火する。
- `s_boilButtonClicked: Stream<Unit>`
	- 沸騰ボタンを押下した際に発火する。
- `s_lid: Stream<LidState>`
	- フタを空け閉めした際に発火する。
	- 開いている状態、閉じている状態の2種類の値を取りうる。
- `s_waterOverflowSensor: Stream<boolean>`
	- 満水センサーから値を受け取るたびに発火する。
	- 現在の実装では`s_tick`と同じタイミング、つまり200ミリ秒ごとに発火する。
- `s_waterLevelSensor: Stream<WaterLevel>`
	- 水位センサーから値を受け取るたびに発火する。
	- 0、1、2、3、4の5種類の値を取りうる。
	- 現在の実装では`s_tick`と同じタイミング、つまり200ミリ秒ごとに発火する。
- `s_errorTemperatureNotIncreased: Stream<Unit>`
	- 温度上がらずエラーが起きたときに発火する。
	- 温度上がらずエラーの条件が揃った際に1分毎に発火する。
- `s_errorTemperatureTooHigh: Stream<Unit>`
	- オーバーヒートした状態のときに随時発火する。
	- 現在の実装では`s_temperature`(温度センサーのストリーム)が発火した際に、条件が揃っていればこのエラーも発火する。
- `s_tick: Stream<number>`
	- 200ミリ秒ごとに発火する。

##  出力

- `Stream<Status>`
	- ステータスを持ったストリームを返す。
	- 沸騰、保温、停止の3種類の値を取りうる。
	- ステータスが切り替わる際にのみ発火する。
		- 例えば、保温モードに切り替わるタイミングのストリームが欲しければ、ステータスの出力のストリームに対してfilterをかけるだけで済む。

## 仕様

- 沸騰ボタンを押したとき、温度制御可能な水位ならば沸騰状態になる。
- ふたが閉じられたとき、温度制御可能な水位ならば沸騰状態になる。
- 沸騰状態で100度に達してから3分間経ったら、保温状態になる。
- 高温エラー・温度上がらずエラーが出たたときには、停止状態になる。
- フタが開いたとき、停止状態になる。
- 満水センサがONのとき、停止状態になる。

### ステータスの出力について

- 沸騰ボタンを押したとき、または、ふたが閉じられたとき、沸騰状態になる
- 沸騰状態で100度に達してから3分間経ったら、保温状態に入る
- 障害状態のとき、前2つの条件を無視して必ず停止状態になる

### 障害状態について

各要因で停止状態になってから、停止状態になった原因が収まり復旧するまでの状態のことを、「障害状態」と名付ける。障害状態の間は、出力は必ず停止状態になる。

障害状態になる原因とその復旧については、次の5種類の要因がある。
- 高温エラー
- 温度上がらずエラー
- 満水センサがON
- 水位が0
- フタが開いている

各要因について、どの要因が障害状態なのかを記録しておく。例えば要因Aによって障害状態になったとき、要因Bが復旧したというストリームが発火したとしても、要因Aは障害状態のままになる。どれか1つの要因でも障害状態ならば、全体としても障害状態となる。

### 障害状態からの復旧について

各原因で障害状態になった際には、原因ごとに異なる復旧要因がある。

- 高温エラーのとき
	- 低温になれば良いので、`s_temperatureSensor`が一定値以下になったら復旧する。
- 温度上がらずエラーのとき
	- フタを開けて水を入れたりした可能性もあるので、フタが閉まったら復旧する。
- 満水センサがONのとき
	- 満水センサがOFFになれば復旧する。停止状態のままだけだけど、他のイベントによって沸騰状態に移行する。
- 水位が0のとき
	- 水位が1以上に慣れば復旧する。停止状態のままだけど、他のイベントによって沸騰状態に移行する。
- フタが開いたとき
	- フタが閉まれば復旧する。同時に沸騰状態へ移行する。

### 注意するべき点
- 障害状態から復旧するストリームが発火する論理的時刻と、沸騰状態に入るストリームが発火する論理的時刻は同じになることがある。なので各状態を適切にmergeする必要がある。
- 障害状態の各要因についても、各要因が同じ論理的時刻に更新されることがある。なので各要因を適切にmergeする必要がある。

## タイミング図

![timing1](../images/frpod-status-timing.png)

